define(["js/qlik","jquery","underscore","./properties","./initialproperties","./lib/js/extensionUtils","text!./lib/css/style.css","./lib/js/d3.v3.min"],function(e,t,r,n,i,o,l,a){"use strict";o.addStyleToHeader(l);var s=[],c=null,d=null;return{definition:n,initialProperties:i,snapshot:{canTakeSnapshot:!0},paint:function(n,i){function l(e){if(e>0){var t=r.where(N,{id:e});r.each(t,function(e){l(e.parent_id),s.push(e.elemNum)})}}function p(e){if(e>0){var t=r.where(N,{parent_id:e});r.each(t,function(e){p(e.id),s.push(e.elemNum)})}}function u(e){e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null)}function h(e){e.children&&(e.children.forEach(h),i.properties.defineCollapseLevel&&e.depth>=i.properties.collapseLevel&&u(e))}function f(e){var t=X.nodes(R).reverse(),r=X.links(t);t.forEach(function(e){e.y=180*e.depth});var n=F.selectAll("g.node").data(t,function(e){return e.id||(e.id=++U)}),o=n.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+e.y0+","+e.x0+")"});o.append("circle").attr("r",1e-6).style("fill",function(e){return e._children?"lightsteelblue":"#fff"}).on("click",y),o.append("text").attr("x",function(e){return e.children||e._children?-10-(i.properties.circleRadius-4)/2:10+(i.properties.circleRadius-4)/2}).attr("dy",".35em").attr("text-anchor",function(e){return e.children||e._children?"end":"start"}).style("font-size",i.properties.fontSize+"px").text(function(e){return i.properties.showMeasure?e.name+": "+e.mea:e.name}).on("click",b).on("mouseover",function(e){m(e)}).on("mouseout",function(){z.transition().duration(500).style("opacity","0")}).style("fill-opacity",1e-6);var l=n.transition().duration(V).attr("transform",function(e){return"translate("+e.y+","+e.x+")"});l.select("circle").attr("r",i.properties.circleRadius).style("fill",function(e){return e._children?"lightsteelblue":"#fff"}),l.select("text").style("fill-opacity",1);var a=n.exit().transition().duration(V).attr("transform",function(){return"translate("+e.y+","+e.x+")"}).remove();a.select("circle").attr("r",1e-6),a.select("text").style("fill-opacity",1e-6);var s=F.selectAll("path.link").data(r,function(e){return e.target.id});s.enter().insert("path","g").attr("class","link").attr("d",function(){var t={x:e.x0,y:e.y0};return B({source:t,target:t})}),s.transition().duration(V).attr("d",B),s.exit().transition().duration(V).attr("d",function(){var t={x:e.x,y:e.y};return B({source:t,target:t})}).remove(),t.forEach(function(e){e.x0=e.x,e.y0=e.y})}function m(e){z.transition().duration(200).style("opacity",".85"),i.properties.showMeasure?j.html(e.name+":"+e.mea):j.html(e.name),z.style("left",a.event.layerX+20+"px").style("top",a.event.layerY+"px").style("left",e+"px").style("top",e+"px").style("z-index",5)}function y(e){e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null),f(e)}function b(e){s.push(e.elemNum),"parent"==i.properties.selectionMode?c=e.parent_id:"child"==i.properties.selectionMode&&(d=e.id),i.properties.clearAll?(g.clearAll(),x.paint(n)):x.paint(n,i)}if(i.qHyperCube.qDimensionInfo.length<3||i.qHyperCube.qMeasureInfo.length<1){var v='<h1 style="font-size: 150%;">This extension requires 3 dimensions and 1 measure to define the Tree Structure.</h1>';return v+="<br />Dimensions:<br /><br />",v+='<b style="color: #1A8C27">Node ID:</b> Numeric ID uniquely identifies each node.<br />',v+='<b style="color: #1A8C27">Parent ID:</b> Numeric ID of the parent node.<br />',v+='<b style="color: #1A8C27">Node Name:</b> Display name of each node.<br />',v+="<br /><br />Measure:<br /><br />",v+='<b style="color: #1A8C27">Measure:</b>  This is a measure value which is displayed beside each node name on the tree. You can optionally input "Sum(1)" here and switch off "Display Measure" property to hide this measure value.<br /><br />',n.html(v),null}i.properties.defineScreenSize&&o.addStyleToHeader("<style>div.qv-object-content-container {overflow: auto;}</style>");var x=this,g=e.currApp(this),q=i.qInfo.qId,_=i.qHyperCube.qDataPages[0].qMatrix,N=_.map(function(e){return{id:e[0].qNum,elemNum:e[0].qElemNumber,parent_id:e[1].qNum,name:e[2].qText,mea:e[3].qText}});if(s&&s.length>0){"parent"==i.properties.selectionMode&&c?l(c):"child"==i.properties.selectionMode&&d&&p(d);var w=0;x.backendApi.selectValues(w,s,!0),s=[],c=null,x.paint(n,i)}var C=r.min(N,function(e){return e.id}),M=C.id,A=function(e,t,n){var i=r.where(N,{parent_id:e}),o=[];if(n++,i.length>0){for(var l=0;l<i.length;l++){var a={id:i[l].id,elemNum:i[l].elemNum,name:i[l].name,parent_id:i[l].parent_id,mea:i[l].mea,depth:n};o[l]=a,A(i[l].id,o[l],n)}return t.children=o,t}return t},S=r.findWhere(N,{id:M}),k=0,D=A(M,S,k),E=t(document.createElement("div"));E.attr("id",q),E.addClass("divTemplateContainer"),n.empty(),n.append(E);var T=t(document.createElement("div"));T.attr("id","tooltip"),T.css({backgroundColor:"white",color:"#000",opacity:0,position:"absolute",border:"1px solid #dbdbdb"}),E.append(T);var I=t(document.createElement("div"));I.attr("id","tooltipcontent"),I.css({color:"#000",font:"11px sans-serif","text-align":"left",padding:"7px"}),I.html("content here"),T.append(I);var z=a.select("#tooltip"),j=a.select("#tooltipcontent"),H=0,P=0;i.properties.defineScreenSize?(H=i.properties.screenWidth,P=i.properties.screenHight):(H=n.width(),P=n.height());var R,L={top:20,right:120,bottom:20,left:120},W=H-L.right-L.left,Y=P-L.top-L.bottom,U=0,V=750,X=a.layout.tree().size([Y,W]),B=a.svg.diagonal().projection(function(e){return[e.y,e.x]}),F=a.select("#"+q).append("svg").attr("width",W+L.right+L.left).attr("height",Y+L.top+L.bottom).append("g").attr("transform","translate("+L.left+","+L.top+")");R=D,R.x0=Y/2,R.y0=0,R.children?(R.children.forEach(h),f(R)):f(R),a.select(x.frameElement).style("height","800px")}}});